@model List<ContractMonthlyClaimSystem.Models.Claim>

@{
    ViewData["Title"] = "Approver Dashboard";

    var role = ViewBag.Role as string ?? "Approver";
    var userId = ViewBag.UserId as int? ?? 0;
}

<h2>@role Dashboard — Pending Claims</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (!Model.Any())
{
    <div class="alert alert-info">
        <h4>No pending claims</h4>
        <p>There are currently no claims waiting for your action.</p>
    </div>
}
else
{
    <div class="table-responsive mt-3">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Claim ID</th>
                    <th>Lecturer</th>
                    <th>Month</th>
                    <th>Total Hours</th>
                    <th>Total Amount (R)</th>
                    <th>Status</th>
                    <th>Submitted</th>
                    <th style="width: 260px">Actions</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var claim in Model)
                {
                    <tr>
                        <td>@claim.ClaimId</td>

                        <td>
                            <strong>@claim.Lecturer?.FullName</strong><br />
                            <small>@claim.Lecturer?.Email</small>
                        </td>

                        <td>@claim.Month</td>
                        <td>@claim.TotalHours.ToString("F1")</td>
                        <td>R @claim.TotalAmount.ToString("N2")</td>

                        <td>
                            <span class="badge
                                        @(claim.Status == "Submitted" ? "bg-warning text-dark" :
                                                                    claim.Status == "Verified" ? "bg-primary" :
                                                                    claim.Status == "Approved" ? "bg-success" :
                                                                    claim.Status == "Processed" ? "bg-info text-dark" :
                                                                    claim.Status == "Rejected" ? "bg-danger" : "bg-secondary")">
                        @claim.Status
                    </span>
                </td>

                        <td>@claim.SubmittedAt.ToString("yyyy-MM-dd")</td>

                        <td>
                            <!-- VIEW DETAILS BUTTON -->
                            <a asp-controller="Claim"
                               asp-action="Details"
                               asp-route-id="@claim.ClaimId"
                               class="btn btn-info btn-sm mb-1">
                                View
                            </a>

                            <!-- ============================= -->
                            <!-- PROGRAMME COORDINATOR ACTIONS -->
                            <!-- ============================= -->
                    @if (role == "Programme Coordinator" && claim.Status == "Submitted")
                            {
                                <form asp-action="Approve" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@claim.ClaimId" />
                                    <input type="hidden" name="approverId" value="@userId" />
                                    <button type="submit" class="btn btn-success btn-sm mb-1">Verify</button>
                                </form>
                            }

                            <!-- ============================= -->
                            <!-- ACADEMIC MANAGER ACTIONS -->
                            <!-- ============================= -->
                            @if (role == "Academic Manager" && claim.Status == "Verified")
                            {
                                <form asp-action="Approve" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@claim.ClaimId" />
                                    <input type="hidden" name="approverId" value="@userId" />
                                    <button type="submit" class="btn btn-primary btn-sm mb-1">Final Approve</button>
                                </form>
                            }

                            <!-- ============================= -->
                            <!-- HR ACTIONS -->
                            <!-- ============================= -->
                            @if (role == "HR" && claim.Status == "Approved")
                            {
                                <form asp-action="Approve" method="post" class="d-inline">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@claim.ClaimId" />
                                    <input type="hidden" name="approverId" value="@userId" />
                                    <button type="submit" class="btn btn-warning btn-sm mb-1">Process</button>
                                </form>
                            }

                            <!-- ============================= -->
                            <!-- REJECT BUTTON (ALL APPROVERS) -->
                            <!-- ============================= -->
                            @if ((role == "Programme Coordinator" ||
                                                role == "Academic Manager" ||
                                                role == "HR") &&
                                                (claim.Status == "Submitted" || claim.Status == "Verified" || claim.Status == "Approved"))
                            {
                                <a asp-controller="Claim"
                                   asp-action="Details"
                                   asp-route-id="@claim.ClaimId"
                                   class="btn btn-danger btn-sm mb-1">
                                    Reject
                                </a>
                            }
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>
}
